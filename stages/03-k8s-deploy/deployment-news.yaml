apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{NEWS_APP_NAME}}
  namespace: {{NAMESPACE}}
spec:
  replicas: {{NEWS_REPLICAS}}
  selector:
    matchLabels:
      app: {{NEWS_APP_NAME}}
  template:
    metadata:
      labels:
        app: {{NEWS_APP_NAME}}
    spec:
      imagePullSecrets:
        - name: regcred

      volumes:
        - name: dotenv
          emptyDir: {}

      initContainers:
        - name: write-dotenv
          image: busybox:1.36
          env:
            - name: INFLUXDB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: influxdb-auth
                  key: DOCKER_INFLUXDB_INIT_ADMIN_TOKEN
          command: ["/bin/sh","-c"]
          args:
            - |
              cat > /work/.env <<EOT
              INFLUXDB_URL=${INFLUXDB_URL}
              INFLUXDB_ORG=${INFLUXDB_ORG}
              INFLUXDB_BUCKET=${INFLUXDB_BUCKET}
              INFLUXDB_TOKEN=${INFLUXDB_ADMIN_TOKEN}
              TICKERS=${TICKERS}
              # lowercase keys (some builds read these)
              org=${INFLUXDB_ORG}
              bucket=${INFLUXDB_BUCKET}
              token=${INFLUXDB_ADMIN_TOKEN}
              tickers=${TICKERS}
              EOT
          volumeMounts:
            - name: dotenv
              mountPath: /work

      containers:
        - name: {{NEWS_APP_NAME}}
          image: {{NEWS_IMAGE}}:{{NEWS_TAG}}
          imagePullPolicy: Always
          ports:
            - containerPort: {{NEWS_CONTAINER_PORT}}
          volumeMounts:
            - name: dotenv
              mountPath: /app/.env
              subPath: .env
          env:
            # canonical vars
            - name: INFLUXDB_URL
              value: "${INFLUXDB_URL}"
            - name: INFLUXDB_ORG
              value: "${INFLUXDB_ORG}"
            - name: INFLUXDB_BUCKET
              value: "${INFLUXDB_BUCKET}"
            - name: INFLUXDB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: influxdb-auth
                  key: DOCKER_INFLUXDB_INIT_ADMIN_TOKEN
            - name: TICKERS
              value: "${TICKERS}"
            # lowercase runtime vars (cover alternate code paths)
            - name: org
              value: "${INFLUXDB_ORG}"
            - name: bucket
              value: "${INFLUXDB_BUCKET}"
            - name: token
              valueFrom:
                secretKeyRef:
                  name: influxdb-auth
                  key: DOCKER_INFLUXDB_INIT_ADMIN_TOKEN
            - name: tickers
              value: "${TICKERS}"

